<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Translator</title>
        <link rel="stylesheet" href="style.css" />
    </head>
    <body>
        <div class="container">
            <!-- Sidebar -->
            <aside class="sidebar">
                <div class="logo">Lectio</div>
                <img
                    src="logos/logo.png"
                    alt="Electio Logo"
                    class="electio-logo"
                />
                <nav>
                    <ul>
                        <li><a href="index.html">Home</a></li>
                        <li>
                            <a href="translation.html" class="active"
                                >Practice</a
                            >
                        </li>
                        <li><a href="/leaderboard.html">Leaderboard</a></li>
                        <li><a href="profile.html">Profile</a></li>
                    </ul>
                </nav>
                <div class="settings">
                    <a href="#">Settings</a>
                    <a href="#">Logout</a>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="main-content">

                <div class="header">
                    <h1>Pick a Context</h1>
                </div>                
                <div class="header">
                    <h2>Ideas on a silver platter</h2>
                </div>
                <!-- Button container where dynamically created context buttons will appear -->
                <div id="context-buttons" class="form-section"></div>
                <button class="custom-btn" onclick="openModal('context-modal')">
                    I've got a better idea!
                </button>


                <!-- Button container where dynamically created types buttons will appear -->
                <div id="types-section">
                    <h1>Pick a text type</h1>
                    <h2>Ideas on a silver platter</h2>
                    <div id="types-buttons" class="form-section"></div>
                    <button class="custom-btn" onclick="openModal('type-modal')">
                        I've got a better idea!
                    </button>
                </div>

                <!-- Fetch Text Button to Combine Inputs -->
                <button class="custom-btn" onclick="fetchCustomText()">
                    Generate
                </button>
                
                <button id="lucky-button" class="large-button" onclick="fetchText('random, but make it fun', 'random, but make it fun')">
                    I'm Feeling Lucky
                </button>

                <!-- Section to display the fetched text -->
                <div id="text-section">
                    <h2>Generated Text</h2>
                    <textarea id="text-display" class="text-output" readonly></textarea> <!-- This will display the fetched text -->
                </div>

                <!-- Popup for translation -->
                <div id="translation-popup" class="popup hidden">
                    <p id="translation-text"></p>
                    <button id="close-popup-button" class="primary-btn">Close</button>
                </div>

                <!-- finish button -->
                <button
                    class="primary-btn"
                    onclick="updateUserScore()"
                >
                    Finish
                </button>
            </main>

            <!-- Modal for Custom Context Input -->
            <div id="context-modal" class="modal hidden">
                <div class="modal-content">
                    <h2>Enter Custom Context</h2>
                    <input type="text" id="custom-context-input" placeholder="Custom context" />
                    <button class="primary-btn" onclick="submitCustomContext()">Submit</button>
                    <button class="primary-btn" onclick="closeModal('context-modal')">Close</button>
                </div>
            </div>

            <!-- Modal for Custom Type Input -->
            <div id="type-modal" class="modal hidden">
                <div class="modal-content">
                    <h2>Enter Custom Type</h2>
                    <input type="text" id="custom-type-input" placeholder="Custom type" />
                    <button class="primary-btn" onclick="submitCustomType()">Submit</button>
                    <button class="primary-btn" onclick="closeModal('type-modal')">Close</button>
                </div>
            </div>

        </div>

        <div id="examples-section">
            <h3>Examples Contexts</h3>
            <pre id="examples-output"></pre>
        </div>

        <script>
            
            async function updateUserScore() {
                console.log('updating user score');
                
                try {
                    const response = await fetch(`/updateUserScore`, {
                        method: 'POST', // Use POST or PUT as appropriate
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ score: 10 }) // Include any required data here
                    });

                    if (response.ok) {
                        console.log('Successfully updated score');
                    } else {
                        console.log('Failed to update score', response.status, response.statusText);
                    }
                } catch (error) {
                    console.log('Error updating score:', error);
                }
                window.location.href = 'dashboard.html';

            }



            let selectedContext = null;
            let selectedType = null;

            // Open modal by setting display to flex
            function openModal(modalId) {
                document.getElementById(modalId).style.display = 'flex';
            }
            // Close modal by setting display to none
            function closeModal(modalId) {
                document.getElementById(modalId).style.display = 'none';
            }

            function submitCustomContext() {
                const customContext = document.getElementById('custom-context-input').value.trim();
                if (customContext) {
                    selectedContext = customContext;
                    console.log(`Custom context submitted: ${customContext}`);
                    closeModal('context-modal');
                    fetchTypes(customContext);
                }
            }

            // Submit custom type and close modal
            function submitCustomType() {
                const customType = document.getElementById('custom-type-input').value.trim();
                if (customType) {
                    selectedType = customType;
                    console.log(`Custom type submitted: ${customType}`);
                    closeModal('type-modal');
                }
            }


            // Handle button clicks for context and type
            function handleContextSelection(context) {
                selectedContext = context;
                console.log(`Selected context from button: ${context}`);
            }

            function handleTypeSelection(type) {
                selectedType = type;
                console.log(`Selected type from button: ${type}`);
            }
            
            // Fetch text using selected button or custom input values
            function fetchCustomText() {
                const contextToUse = selectedContext;
                const typeToUse = selectedType;

                if (contextToUse && typeToUse) {
                    console.log(`Fetching text with context: ${contextToUse} and type: ${typeToUse}`);
                    fetchText(contextToUse, typeToUse);
                } else {
                    console.log("Please select or enter both a context and type.");
                }
            }
            // Fetch contexts from your server's /get-contexts endpoint and create buttons
            async function fetchContexts() {
                try {
                    const response = await fetch('/get-contexts'); // Fetching from your server's endpoint
                    if (response.ok) {
                        const contexts = await response.json();
                        const contextButtonsContainer = document.getElementById('context-buttons');

                        // Clear any existing buttons
                        contextButtonsContainer.innerHTML = '';

                        // Variable to store the currently active button
                        let contextActiveButton = null;

                        // Create a button for each context
                        contexts.forEach(context => {
                            const button = document.createElement('button');
                            button.textContent = context;
                            button.classList.add('primary-btn'); // Apply button styling

                            button.addEventListener('click', () => {
                                console.log(`Context clicked: ${context}`); // Log context to confirm the button was clicked
                                
                                if (contextActiveButton) {
                                    contextActiveButton.classList.remove('active');
                                }
                                button.classList.add('active');
                                contextActiveButton = button;

                                fetchTypes(context); // Call function to fetch types based on the context
                            });
                            contextButtonsContainer.appendChild(button);
                        });
                    } else {
                        console.error('Error fetching contexts');
                    }
                } catch (error) {
                    console.error('Fetch error: ', error);
                }
            }

            // Fetch types from /get-text-types endpoint when a context button is clicked
            async function fetchTypes(context) {
                try {
                    console.log(`Fetching types for context: ${context}`); // Debug log to confirm request is triggered
                    const response = await fetch(`/get-text-types?context=${encodeURIComponent(context)}`); // Fetch types based on the selected context

                    if (response.ok) {
                        const types = await response.json();
                        const typesButtonsContainer = document.getElementById('types-buttons'); // Assuming there's a div for types buttons

                        // Clear any existing buttons
                        typesButtonsContainer.innerHTML = '';

                        // Variable to store the currently active button
                        let typeActiveButton = null;


                        // Create a button for each type
                        types.forEach(type => {
                            const button = document.createElement('button');
                            button.textContent = type;
                            button.classList.add('primary-btn'); // Apply button styling
                            button.addEventListener('click', () => {
                                console.log(`Type clicked: ${type} for context: ${context}`); // Log type and context

                                if (typeActiveButton) {
                                    typeActiveButton.classList.remove('active');
                                }
                                button.classList.add('active');
                                typeActiveButton = button;

                                fetchText(context, type); // Call function to fetch text based on context and type
                            });
                            typesButtonsContainer.appendChild(button);
                        });
                    } else {
                        console.error('Error fetching types');
                    }
                } catch (error) {
                    console.error('Fetch error: ', error);
                }
            }

            // Fetch text based on both context and type when a type button is clicked
            async function fetchText(context, type) {
                try {
                    console.log(`Fetching text for context: ${context}, type: ${type}`); // Debug log to confirm request

                    // Send request to API with both context and type
                    const response = await fetch(`/get-text?context=${encodeURIComponent(context)}&type=${encodeURIComponent(type)}`);

                    if (response.ok) {
                        const data = await response.json();
                        console.log("Received text:", data); // Debug log to check the received data

                        // Replace new lines with <br> for proper HTML formatting
                        const formattedText = data.replace(/<br>/g, '\n'); // Convert <br> tags back to new lines if present

                        // You can now handle the fetched text, display it, or perform another action
                        const textDisplay = document.getElementById('text-display');
                        textDisplay.innerHTML = formattedText; // Use innerHTML to render HTML
                    } else {
                        console.error('Error fetching text');
                    }
                } catch (error) {
                    console.error('Fetch error: ', error);
                }
            }

            function highlightText() {
              const textArea = document.getElementById("text-display");
              console.log(textArea.selectionStart);
              const selectedText = textArea.value.substring(textArea.selectionStart, textArea.selectionEnd);

              if (selectedText.length > 0) {
                console.log(`Translating '${selectedText}' to Swedish`);
                fetch(`/translate?word=${encodeURIComponent(selectedText)}`)
                  .then(response => response.json())
                  .then(data => {
                    const translation = data.translation;

                    const popup = document.getElementById("translation-popup");
                    document.getElementById("translation-text").textContent = `The translation of '${selectedText}' is: ${translation}`;
                    popup.style.display = "block";

                    console.log('nu')
                    console.log(selectedText)
                    console.log(translation)
                    saveWord(selectedText, translation);
                  })
                  .catch(error => {
                    console.error('Error during translation:', error);
                  });
              } else {
                console.log("No text selected");
              }
            }

            function saveWord(word, translation) {
              console.log('heheheheh')
              fetch('/save-word', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({ word, translation }),
              })
              .then(response => response.json())
              .then(data => {
                if (data.success) {
                  console.log('Word saved successfully:', data.id);
                } else {
                  console.error('Error saving word:', data.error);
                }
              })
              .catch(error => console.error('Error:', error));
            }

            function closePopup() {
              document.getElementById("translation-popup").style.display = "none";
            }

            document.getElementById("text-display").addEventListener("mouseup", highlightText);
            document.getElementById("close-popup-button").addEventListener("click", closePopup);

            // Call the fetch function when the page loads
            document.addEventListener('DOMContentLoaded', fetchContexts);
            // Add event listeners to button-based context and type options
            document.addEventListener('DOMContentLoaded', () => {
                const contextButtons = document.getElementById('context-buttons').getElementsByTagName('button');
                for (let button of contextButtons) {
                    button.addEventListener('click', () => {
                        selectedContext = button.textContent;
                        console.log(`Selected context from button: ${selectedContext}`);
                    });
                }

                const typeButtons = document.getElementById('types-buttons').getElementsByTagName('button');
                for (let button of typeButtons) {
                    button.addEventListener('click', () => {
                        selectedType = button.textContent;
                        console.log(`Selected type from button: ${selectedType}`);
                    });
                }
            });

        </script>
    </body>
</html>
